<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome file</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#interactive-development-in-f">Interactive development in F#</a>
<ul>
<li><a href="#what-is-a-repl-now-and-what-it-could-be">What is a REPL now and what it could be</a></li>
<li><a href="#improving-f-repl">Improving F# REPL</a></li>
<li><a href="#creating-a-simple-platformer-game-in-f">Creating a simple platformer game in F#</a></li>
<li><a href="#adding-player-and-basic-movement">Adding player and basic movement</a></li>
<li><a href="#adding-physics">Adding physics</a></li>
<li><a href="#platforms-and-hitboxes">Platforms and hitboxes</a></li>
<li><a href="#adding-textures">Adding textures</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <h1 id="interactive-development-in-f">Interactive development in F#</h1>
<p>Hi all, in this article I wanna show how you can use interactive programming techniques to write software in faster and more enjoyable way. Also, we are going to impement simple game in F# and take a look at</p>
<h2 id="what-is-a-repl-now-and-what-it-could-be">What is a REPL now and what it could be</h2>
<p>REPL (read-eval-print-loop) is a simple program which reads code entered by a user, evaluates it and prints back to the user. It allows user to actually interact with a language they’re working with: they can immediately see results of expressions they type, assign these expressions to variables and reuse variables in further expressions. So user can execute what they want step-by-step, quickly test new code, inspecting existing state, etc.</p>
<p>Nowadays almost every language has some form of REPL. Usually, they are treated as minor addition to language implementation - as learning tool for beginner or a way to quickly test new ideas. Sometimes they are treated more seriously: <a href="https://jupyter.org/">jupiter-notebook</a>, for example, is a great and immensely popular tool for different kinds of scientific computations. But what if we could use such interactive tool for actual software development? Not only for small scripts or ‘drafty/sketchy??’ experiments, but real software?</p>
<p>The bigger a software gets, the more painful and slow it becomes to debug and modify it. Compilation time increases, internal state gets more and more complicated and hard to reproduce. I actually got burned out from my previous job as to reproduce the tiniest bug i had to wait at least 5 minutes for compilation, few minutes of program start up, and then navigate through dozens of different windows and menus. And guess what feature is the most prominent in REPLs? That’s right, fast feedback loop! Wouldn’t it be great to execute program once in a repl, capture needed state and reevaluate needed function until it stops failing?</p>
<p>A lot of REPLs already can do that. Entire family of LISP languages are known for their powerful REPLs. Moreover, REPLs were firstly introduced in early LISP implementations and term itself comes from minimal REPL definition written in lisp:</p>
<pre class=" language-lisp"><code class="prism  language-lisp">(loop (print (eval (read))))
</code></pre>
<p>Typical LISP repl has many features your average modern repl lacks:</p>
<style>
  li {
    margin-bottom: 0.75rem;
  }
</style>
<ul>
<li>ability to load entire project into repl</li>
<li>ability to modify any function (compared to just adding new function with same name)</li>
<li>advanced error handling - if your expression throws an error, repl acts like  interactive debugger - it opens new  sub-repl which has all context of faulty function.</li>
<li>ability to persist entire repl state, with all variables and memory intact into a file. So u can easily restore it for next sessions</li>
<li>ability to attach to existing remote process and execute repl commands in it<br>
Lisp machines were a pinnacle of such magic. All programs shared a single large address space, so user could inspect, evaluate or modify any function of any program on their computer. Instead of <code>sh</code> executing binaries, they had lisp repl executing lisp functions.</li>
</ul>
<p>One notable example of lisps is <a href="https://clojure.org/">Clojure</a>. It is modern language, with strong focus on functional programming which works on top of JVM. And good repl is <a href="https://clojure.org/guides/repl/introduction">one of it’s most compelling features</a>. And honestly, by discovering and trying out this language I fell in love with repl driven development. So I’ve started wondering - why not use same approach, but in my favorite F#?</p>
<h2 id="improving-f-repl">Improving F# REPL</h2>
<p>For being actual development tool, dotnet fsi lacks 2 important features.</p>
<ol>
<li>Putting entire project into repl.<br>
fsi is designed to work with .fsx script files, not actual projects or solutions.</li>
<li>Hot reloading of already compiled functions. Compared to lisp’s, you cannot simply modify parts of running code. Sure, you can reevaluate a function, but instead of modifying existing one, it would just create new one with same name, so you’d need to reevaluate all functions which depend on this function too;</li>
</ol>
<p>First feature is easily solvable. As fsi supports loading of DDLs, you just need to reference all binaries of your program. And a lot of tools, like vscode-ionide, allow you to generate such references in a single command.</p>
<p>But without second feature repl as dev tool loses it’s core benefit - fast feedback loop. How it even differs from regular edit-compile-run cycle if u need for every minor change recompile project, restart repl and re-reference all dlls?</p>
<p>Modifying .net assembly in runtime is, thankfully, relatively easy, and there are many libraries, like <a href="https://github.com/pardeike/Harmony">Harmony</a> that do this. Of course, there are still clr limitations as we cannot identify existing types, change function signatures, or modify generic functions.</p>
<p>And to fix those limitations I’ve made <a href="https://github.com/soweli-p/FsiX">fsix</a>, a repl which contains these features as well as some additional niceties. In next chapter, I will demonstrate how repl driven development might increase your development speed and comfort.</p>
<h2 id="creating-a-simple-platformer-game-in-f">Creating a simple platformer game in F#</h2>
<p>For demonstration lets create simple video game - because it’s fun and because it’s a perfect place where interactive programming really shines. We will use <a href="https://funcui.avaloniaui.net/">Avalonia.FuncUI</a> for drawing and IO. Sure, this is UI library, not gamedev lib. But it is very simple, f# friendly, supports everything we need and has support for <a href="https://elmish.github.io/elmish/">Elmish</a> MVU pattern, which is functional and transforms perfectly onto classical gameloop pattern.</p>
<h3 id="basic-architecture">Basic architecture</h3>
<p>Our project will contain 3 core files:</p>
<ul>
<li>Update.fs, which contains our state type, event type and function which on some event updates state:</li>
</ul>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">module</span> Cubicle<span class="token punctuation">.</span>Update
<span class="token keyword">open</span> Avalonia<span class="token punctuation">.</span>Input

<span class="token keyword">type</span> GameState <span class="token operator">=</span> unit

<span class="token keyword">type</span> Event <span class="token operator">=</span> 
  <span class="token operator">|</span> Tick
  <span class="token operator">|</span> KeyPressed <span class="token keyword">of</span> Key
  <span class="token operator">|</span> KeyReleased <span class="token keyword">of</span> Key


<span class="token keyword">let</span> <span class="token function">initFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> GameState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> updateFn <span class="token keyword">event</span> state <span class="token operator">=</span> state

</code></pre>
<ul>
<li>View.fs, which contains a function which creates a view model for given state:</li>
</ul>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">module</span> Cubicle<span class="token punctuation">.</span>View
<span class="token keyword">open</span> Avalonia<span class="token punctuation">.</span>FuncUI<span class="token punctuation">.</span>DSL
<span class="token keyword">open</span> Elmish

<span class="token keyword">open</span> Cubicle<span class="token punctuation">.</span>Update


<span class="token keyword">let</span> <span class="token function">viewFn</span> <span class="token punctuation">(</span>s<span class="token punctuation">:</span> GameState<span class="token punctuation">)</span> <span class="token punctuation">(</span>d<span class="token punctuation">:</span> Dispatch<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> IView <span class="token operator">=</span> 
  Panel<span class="token punctuation">.</span>create <span class="token punctuation">[</span>
    Panel<span class="token punctuation">.</span>background <span class="token string">"#504945"</span>
  <span class="token punctuation">]</span>
  
</code></pre>
<ul>
<li>and Program.fs, which takes all of that and wraps in a program:</li>
</ul>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">module</span> Cubicle<span class="token punctuation">.</span>Program
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">type</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> this <span class="token operator">=</span>
    <span class="token keyword">inherit</span> <span class="token function">HostWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">do</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span>Title <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token string">"Cubicle"</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span>Height <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token number">400.0</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span>Width <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token number">400.0</span>

        Program<span class="token punctuation">.</span>mkSimple Update<span class="token punctuation">.</span>initFn Update<span class="token punctuation">.</span>updateFn View<span class="token punctuation">.</span>viewFn
        <span class="token operator">|</span><span class="token operator">&gt;</span> Program<span class="token punctuation">.</span>withHost this
        <span class="token operator">|</span><span class="token operator">&gt;</span> Program<span class="token punctuation">.</span>withSubscription subscriptions
        <span class="token operator">|</span><span class="token operator">&gt;</span> Program<span class="token punctuation">.</span>run

<span class="token keyword">type</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">module</span> Program <span class="token operator">=</span>

    <span class="token punctuation">[</span><span class="token operator">&lt;</span>EntryPoint<span class="token operator">&gt;</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        AppBuilder
            <span class="token punctuation">.</span>Configure<span class="token operator">&lt;</span>App<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UsePlatformDetect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseSkia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">StartWithClassicDesktopLifetime</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
            
</code></pre>
<p>So, this is basic template for our game, which at this moment simply shows blank screen.</p>
<h2 id="adding-player-and-basic-movement">Adding player and basic movement</h2>
<p>Ok let’s start actually coding!</p>
<p>First, we need to add event emitters for our game. By looking at our <code>Event</code> type, you can see that one of them would emit ticks every <code>n</code> miliseconds, and two other would provide basic keyboard controls:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> <span class="token function">subscriptions</span> <span class="token punctuation">(</span>_state<span class="token punctuation">:</span> GameState<span class="token punctuation">)</span> <span class="token operator">=</span>
          <span class="token keyword">let</span> <span class="token function">timerSub</span> <span class="token punctuation">(</span>dispatch<span class="token punctuation">:</span> Dispatch<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
            <span class="token keyword">let</span> <span class="token function">invoke</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
                Event<span class="token punctuation">.</span>Tick <span class="token operator">|</span><span class="token operator">&gt;</span> dispatch
                <span class="token keyword">true</span>

            DispatcherTimer<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>invoke<span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span>FromMilliseconds <span class="token number">16.0</span><span class="token punctuation">)</span>

          <span class="token keyword">let</span> <span class="token function">keyDownSub</span> <span class="token punctuation">(</span>dispatch<span class="token punctuation">:</span> Dispatch<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
              this<span class="token punctuation">.</span>KeyDown<span class="token punctuation">.</span><span class="token function">Subscribe</span><span class="token punctuation">(</span><span class="token keyword">fun</span> eventArgs <span class="token operator">-</span><span class="token operator">&gt;</span> KeyPressed eventArgs<span class="token punctuation">.</span>Key <span class="token operator">|</span><span class="token operator">&gt;</span> dispatch<span class="token punctuation">)</span>
          <span class="token keyword">let</span> <span class="token function">keyUpSub</span> <span class="token punctuation">(</span>dispatch<span class="token punctuation">:</span> Dispatch<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
              this<span class="token punctuation">.</span>KeyUp<span class="token punctuation">.</span><span class="token function">Subscribe</span><span class="token punctuation">(</span><span class="token keyword">fun</span> eventArgs <span class="token operator">-</span><span class="token operator">&gt;</span> KeyReleased eventArgs<span class="token punctuation">.</span>Key <span class="token operator">|</span><span class="token operator">&gt;</span> dispatch<span class="token punctuation">)</span>

          <span class="token punctuation">[</span> <span class="token punctuation">[</span> nameof timerSub <span class="token punctuation">]</span><span class="token punctuation">,</span> timerSub
            <span class="token punctuation">[</span> nameof keyDownSub <span class="token punctuation">]</span><span class="token punctuation">,</span> keyDownSub 
            <span class="token punctuation">[</span> nameof keyUpSub <span class="token punctuation">]</span><span class="token punctuation">,</span> keyUpSub 
          <span class="token punctuation">]</span>

<span class="token comment">// And modify our program to include these event emmiters</span>
Program<span class="token punctuation">.</span>mkSimple Update<span class="token punctuation">.</span>initFn Update<span class="token punctuation">.</span>updateFn View<span class="token punctuation">.</span>viewFn
<span class="token operator">|</span><span class="token operator">&gt;</span> Program<span class="token punctuation">.</span>withHost this
<span class="token operator">|</span><span class="token operator">&gt;</span> Program<span class="token punctuation">.</span>withSubscription subscriptions
<span class="token operator">|</span><span class="token operator">&gt;</span> Program<span class="token punctuation">.</span>run

</code></pre>
<p>Now, let’s add player to our game. For now, it will include player’s position and velocity:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> playerSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
<span class="token keyword">type</span> Player <span class="token operator">=</span> <span class="token punctuation">{</span>
  Position<span class="token punctuation">:</span> Vector
  Velocity<span class="token punctuation">:</span> Vector
<span class="token punctuation">}</span>
<span class="token keyword">type</span> GameState <span class="token operator">=</span> <span class="token punctuation">{</span>
  Player<span class="token punctuation">:</span> Player
<span class="token punctuation">}</span>
<span class="token keyword">let</span> <span class="token function">initFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> GameState <span class="token operator">=</span> 
  <span class="token punctuation">{</span> Player <span class="token operator">=</span> <span class="token punctuation">{</span> Position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
               Velocity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token keyword">let</span> updateFn <span class="token operator">=</span> <span class="token keyword">function</span> 
  <span class="token operator">|</span> Tick <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>s<span class="token punctuation">:</span> GameState<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> s
  <span class="token operator">|</span> _ <span class="token operator">-</span><span class="token operator">&gt;</span> id
  
</code></pre>
<p>We also need to draw this player. For now, let it be just a small orange cube:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> <span class="token function">playerToPoints</span> <span class="token punctuation">(</span>resolution<span class="token punctuation">:</span> Vector<span class="token punctuation">)</span> <span class="token punctuation">(</span>p<span class="token punctuation">:</span> Player<span class="token punctuation">)</span> <span class="token operator">=</span> 
  <span class="token keyword">let</span> newPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Position<span class="token punctuation">.</span>X<span class="token punctuation">,</span> resolution<span class="token punctuation">.</span>Y <span class="token operator">-</span> p<span class="token punctuation">.</span>Position<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
  <span class="token punctuation">[</span>
    newPos
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>X<span class="token punctuation">,</span> newPos<span class="token punctuation">.</span>Y <span class="token operator">+</span> playerSize<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>X <span class="token operator">+</span> playerSize<span class="token punctuation">.</span>Y<span class="token punctuation">,</span> newPos<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>newPos<span class="token punctuation">.</span>X <span class="token operator">+</span> playerSize<span class="token punctuation">.</span>Y<span class="token punctuation">,</span> newPos<span class="token punctuation">.</span>Y <span class="token operator">+</span> playerSize<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
kj
<span class="token keyword">let</span> drawPlayer res player<span class="token punctuation">:</span> IView <span class="token operator">=</span> 
  Polygon<span class="token punctuation">.</span>create <span class="token punctuation">[</span>
    <span class="token keyword">let</span> points <span class="token operator">=</span> playerToPoints res player
    Shapes<span class="token punctuation">.</span>Polygon<span class="token punctuation">.</span>points points
    Shapes<span class="token punctuation">.</span>Polygon<span class="token punctuation">.</span>fill <span class="token string">"#fe8019"</span>
  <span class="token punctuation">]</span>

</code></pre>
<p>In graphics, coordinates start from top left corner. But it feels more natural to start with bottom left corner, if you are working with game logic. So <code>playerToPoints</code> takes into account window resolution and converts player to 4 points on screen.</p>
<p>Let’s run our game in repl! And we can also make init script which will open all our modules and start a game immediately in repl:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">open</span> Cubicle<span class="token punctuation">.</span>Program
<span class="token keyword">open</span> Cubicle<span class="token punctuation">.</span>View
<span class="token keyword">open</span> Cubicle<span class="token punctuation">.</span>Update
<span class="token comment">//open all other needed avalonia and lens modules</span>

<span class="token keyword">open</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks
Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Program<span class="token punctuation">.</span>main <span class="token punctuation">[</span><span class="token operator">||</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre>
<p>So we can start our project in repl immediately by command like<br>
<code>dotnet build &amp;&amp; fsix --use repl.fsx</code></p>
<p>Aaand, we messed up somewhere with polygons:<br>
<img src="videos/sandclock.png" alt=""></p>
<p>Elmish is optimized to not update view if it wasn’t changed, and as our update function does nothing, even if we modify it, it wont run new view function. So, let’s make our update function do something.</p>
<p>For modifying game state, I will use <a href="https://fsprojects.github.io/FSharpPlus/lens.html">Lenses</a> - constructs which allow us to focus on, inspect and modify specific elements in complex nested structures. Here are some examples:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">module</span> Lenses <span class="token operator">=</span> 


  <span class="token punctuation">[</span><span class="token operator">&lt;</span>AutoOpen<span class="token operator">&gt;</span><span class="token punctuation">]</span>
  <span class="token keyword">module</span> Player <span class="token operator">=</span>
      <span class="token keyword">let</span> <span class="token keyword">inline</span> _pos f p <span class="token operator">=</span>
          f p<span class="token punctuation">.</span>Position <span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span> <span class="token keyword">fun</span> x <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> p <span class="token keyword">with</span> Position <span class="token operator">=</span> x <span class="token punctuation">}</span>
      <span class="token keyword">let</span> <span class="token keyword">inline</span> _vel f p <span class="token operator">=</span>
          f p<span class="token punctuation">.</span>Velocity <span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span> <span class="token keyword">fun</span> x <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> p <span class="token keyword">with</span> Velocity <span class="token operator">=</span> x <span class="token punctuation">}</span>

  <span class="token punctuation">[</span><span class="token operator">&lt;</span>AutoOpen<span class="token operator">&gt;</span><span class="token punctuation">]</span>
  <span class="token keyword">module</span> GameState <span class="token operator">=</span>
      <span class="token keyword">let</span> <span class="token keyword">inline</span> _player f s <span class="token operator">=</span>
          f s<span class="token punctuation">.</span>Player <span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span> <span class="token keyword">fun</span> x <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> s <span class="token keyword">with</span> Player <span class="token operator">=</span> x <span class="token punctuation">}</span>

</code></pre>
<p>So basically, lens is a pair of getter and setter for specific element in bigger type. We provided setter for player.velocity, player.position and state.player. Usually, such trivial templatish lenses are autogenerated, but I dont wanna mess here with code generators.</p>
<p>Let’s also make lenses to modify either X or Y in given vector:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> <span class="token keyword">inline</span> _1v <span class="token function">f</span> <span class="token punctuation">(</span>v<span class="token punctuation">:</span> Vector<span class="token punctuation">)</span> <span class="token operator">=</span> f v<span class="token punctuation">.</span>X <span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span> <span class="token keyword">fun</span> x <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> v<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token keyword">inline</span> _2v <span class="token function">f</span> <span class="token punctuation">(</span>v<span class="token punctuation">:</span> Vector<span class="token punctuation">)</span> <span class="token operator">=</span> f v<span class="token punctuation">.</span>Y <span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token operator">&gt;</span> <span class="token keyword">fun</span> y <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

</code></pre>
<p>Really nice feature about lenses is that you can compose them. Consider you want a lens from gamestate to player position or velocity. You can easily do that using functional composition over two existing lenses:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> posL <span class="token operator">=</span> _player <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _pos
<span class="token keyword">let</span> velL <span class="token operator">=</span> _player <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _vel

</code></pre>
<p>There are 2 important functions we gonna use a lot:</p>
<ul>
<li>setl - sets new value by using given lens. It has signature like <code>(lens 'T -&gt; 't) -&gt; 't -&gt; 'T -&gt; 'T</code></li>
<li>over - modifies value by using given lens. It has signature like <code>(lens 'T -&gt; 't) -&gt; ('t -&gt; 't) -&gt; 'T -&gt; 'T</code></li>
</ul>
<p>So, if we want to update player position and move it 20 pixels right, instead of nested <code>with</code> expressions, we can simply write</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp"><span class="token function">over</span> <span class="token punctuation">(</span>posL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token number">20.0</span><span class="token punctuation">)</span>
</code></pre>
<p>Let’s now update our game logic to move on WASD:<br>
<img src="videos/wasd.png" alt=""></p>
<p>And our render can be easily fixed by proper order of points. Now we can test it as our state updates every time we move:<br>
<video width="320" height="240" controls loop>
<source	src="videos/wasdFixed.webm" type="video/webm">
</video>
</p>
<h2 id="adding-physics">Adding physics</h2>
<p>Ok, but moving by only changing position feels clunky. And we are making a platformer, so we definitely need to add gravity.(change)</p>
<p>Let’s make player move based on velocity, not just statically update it’s position:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">module</span> Physics <span class="token operator">=</span> 
  <span class="token keyword">let</span> playerVeocity <span class="token operator">=</span> <span class="token number">10.0</span>
  <span class="token keyword">let</span> applyVel s <span class="token operator">=</span> over <span class="token function">posL</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> s<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>Velocity<span class="token punctuation">)</span> s

<span class="token keyword">open</span> Physics
<span class="token keyword">let</span> updateFn <span class="token operator">=</span> <span class="token keyword">function</span> 
  <span class="token operator">|</span> Tick <span class="token operator">-</span><span class="token operator">&gt;</span> applyVel
  <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>W <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> playerVeocity<span class="token punctuation">)</span>
  <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>A <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token operator">-</span>playerVeocity<span class="token punctuation">)</span>
  <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>S <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token operator">-</span>playerVeocity<span class="token punctuation">)</span>
  <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>D <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> playerVeocity<span class="token punctuation">)</span>
  <span class="token operator">|</span> _ <span class="token operator">-</span><span class="token operator">&gt;</span> id

</code></pre>
<p>
<video width="320" height="240" controls loop>
<source	src="videos/spacemoving.webm" type="video/webm">
</video>
</p>
<p>But there is no drag! Player keeps moving like they’d do in space vacuum. Instead, let’s stop player after moving button is released:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
  <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>W <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token number">0.0</span>
  <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>A <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token number">0.0</span> 
  <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>S <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token number">0.0</span>
  <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>D <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token number">0.0</span>
  
</code></pre>
<p>
<video width="320" height="240" controls loop>
<source	src="videos/fixedspacemoving.webm" type="video/webm">
</video>
</p>
<p>For more natural moving, we should add drag. Oh and also gravity!</p>
<p>Gravity would work like that:</p>
<ol>
<li>There is constant force/velocity g moving us downwards</li>
<li>If we are staying on the floor, it counteracts gravity</li>
<li>When player jumps, it’s vertical velocity overcomes gravity, but gravity gradually returns back</li>
</ol>
<p>We also need to be sure that player can jump only when it touches the ground. So we’d need a flag for that:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">type</span> Player <span class="token operator">=</span> <span class="token punctuation">{</span>
  Position<span class="token punctuation">:</span> Vector
  Velocity<span class="token punctuation">:</span> Vector
  Grounded<span class="token punctuation">:</span> bool
<span class="token punctuation">}</span>

</code></pre>
<p>And yeah, that sucks - as we modified player type, we cannot use hot reloading anymore, we need recompile and restart our project. So, sometimes static type system has it’s downsides!</p>
<p>But before we restart game, let’s add gravity logic:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
  <span class="token keyword">module</span> Gravity <span class="token operator">=</span> 
    <span class="token keyword">let</span> g <span class="token operator">=</span> <span class="token number">10.0</span>
    <span class="token keyword">let</span> applyG <span class="token operator">=</span> <span class="token keyword">function</span>
      <span class="token comment">//if player is in jump, slowly make it move faster and faster to the ground, untill he meets terminal g velocity</span>
      <span class="token operator">|</span> s <span class="token keyword">when</span> s<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>Y <span class="token operator">&gt;</span> <span class="token operator">-</span>g <span class="token operator">&amp;&amp;</span> <span class="token keyword">not</span> s<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>Grounded <span class="token operator">-</span><span class="token operator">&gt;</span> 
        <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> s
      <span class="token comment">//set g velocity to grounded objects</span>
      <span class="token operator">|</span> s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span>g<span class="token punctuation">)</span> s
    <span class="token keyword">let</span> floorCheck <span class="token operator">=</span> <span class="token keyword">function</span>
      <span class="token operator">|</span> s <span class="token keyword">when</span> s<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>Position<span class="token punctuation">.</span>Y <span class="token operator">&lt;=</span> <span class="token number">30</span> <span class="token operator">-</span><span class="token operator">&gt;</span>
        s 
        <span class="token operator">|</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>posL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token number">30</span>
        <span class="token operator">|</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>_player <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _grounded<span class="token punctuation">)</span> <span class="token keyword">true</span>
      <span class="token operator">|</span> s <span class="token operator">-</span><span class="token operator">&gt;</span> s

    <span class="token keyword">let</span> jump <span class="token operator">=</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2.0</span><span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>_player <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _grounded<span class="token punctuation">)</span> <span class="token keyword">false</span>



<span class="token keyword">let</span> updateFn <span class="token operator">=</span> <span class="token keyword">function</span> 
  <span class="token operator">|</span> Tick <span class="token operator">-</span><span class="token operator">&gt;</span> applyVel <span class="token operator">&gt;</span><span class="token operator">&gt;</span> applyG <span class="token operator">&gt;</span><span class="token operator">&gt;</span> floorCheck
  <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>Space <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">function</span> 
      <span class="token operator">|</span> s <span class="token keyword">when</span> s<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>Grounded <span class="token operator">-</span><span class="token operator">&gt;</span> jump s 
      <span class="token operator">|</span> s <span class="token operator">-</span><span class="token operator">&gt;</span> s
  <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>A <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token operator">-</span>playerVeocity<span class="token punctuation">)</span>
  <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>S <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token operator">-</span>playerVeocity<span class="token punctuation">)</span>
  <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>D <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> playerVeocity<span class="token punctuation">)</span>
  <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>A <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token number">0.0</span> 
  <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>S <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _2v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2.0</span><span class="token operator">*</span>g<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>D <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token number">0.0</span>
  <span class="token operator">|</span> _ <span class="token operator">-</span><span class="token operator">&gt;</span> id
  
</code></pre>
<p>In similar way, let’s add drag - so on releasing movement button player doesn’t stop immediately, but has some small inertia.</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">type</span> Player <span class="token operator">=</span> <span class="token punctuation">{</span>
  Position<span class="token punctuation">:</span> Vector
  Velocity<span class="token punctuation">:</span> Vector
  Grounded<span class="token punctuation">:</span> bool
  Drag<span class="token punctuation">:</span> float
<span class="token punctuation">}</span>

</code></pre>
<p>Drag applies only to side motions, so it can be represented as single float. We will create drag force only when player stops moving sideways. But when player starts moving, moving will compensate any drag so for simplification we can set it to zero:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
      <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>A <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token operator">-</span>playerVelocity <span class="token operator">&gt;</span><span class="token operator">&gt;</span> setl dragL <span class="token number">0</span>
      <span class="token operator">|</span> KeyPressed Key<span class="token punctuation">.</span>D <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">setl</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> playerVelocity <span class="token operator">&gt;</span><span class="token operator">&gt;</span> setl dragL <span class="token number">0</span>
      <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>A <span class="token operator">-</span><span class="token operator">&gt;</span> setl dragL <span class="token operator">-</span>dragForce
      <span class="token operator">|</span> KeyReleased Key<span class="token punctuation">.</span>D <span class="token operator">-</span><span class="token operator">&gt;</span> setl dragL dragForce

</code></pre>
<p>And, function to apply this drag:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
  <span class="token keyword">module</span> Drag <span class="token operator">=</span> 
    <span class="token keyword">let</span> dragForce <span class="token operator">=</span> <span class="token number">2.0</span>

    <span class="token keyword">let</span> <span class="token function">applyDrag</span> <span class="token punctuation">(</span>s<span class="token punctuation">:</span> GameState<span class="token punctuation">)</span> <span class="token operator">=</span>
      <span class="token keyword">match</span> s<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>Drag<span class="token punctuation">,</span> s<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>X <span class="token keyword">with</span>
      <span class="token operator">|</span> d<span class="token punctuation">,</span> v <span class="token keyword">when</span> d <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> v <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> d <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> v <span class="token operator">&lt;</span> <span class="token number">0</span>
          <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">over</span> <span class="token punctuation">(</span>velL <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _1v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token operator">-</span>d<span class="token punctuation">)</span> s
      <span class="token operator">|</span> d<span class="token punctuation">,</span> _  <span class="token keyword">when</span> d <span class="token operator">&lt;</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token operator">&gt;</span> 
        setl dragL <span class="token number">0</span> s
      <span class="token operator">|</span> _<span class="token punctuation">,</span> _ <span class="token operator">-</span><span class="token operator">&gt;</span> s

</code></pre>
<p>So now we have inertia and gravity.</p>
<h2 id="platforms-and-hitboxes">Platforms and hitboxes</h2>
<p>But what a platofmer doesn’t have platforms? Let’s add them! But firstly, let’s think what common in our game is in platform and player - they are both rectangles, they are both needed to be drawn on screen, and they are collidable with each other.</p>
<p>So, let’s represent them as hitboxes:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">type</span> Hitbox <span class="token operator">=</span> <span class="token punctuation">{</span>
  Min<span class="token punctuation">:</span> Vector
  Max<span class="token punctuation">:</span> Vector
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Platfotm <span class="token operator">=</span> <span class="token punctuation">{</span>
  Hitbox<span class="token punctuation">:</span> Hitbox
<span class="token punctuation">}</span> <span class="token keyword">with</span> <span class="token keyword">member</span> this<span class="token punctuation">.</span>GetHitbox <span class="token operator">=</span> this<span class="token punctuation">.</span>Hitbox

<span class="token keyword">type</span> Player <span class="token operator">=</span> <span class="token punctuation">{</span>
  Position<span class="token punctuation">:</span> Vector
  Velocity<span class="token punctuation">:</span> Vector
  Grounded<span class="token punctuation">:</span> bool
  Drag<span class="token punctuation">:</span> float
<span class="token punctuation">}</span> <span class="token keyword">with</span> <span class="token keyword">member</span> this<span class="token punctuation">.</span>GetHitbox <span class="token operator">=</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> this<span class="token punctuation">.</span>Position<span class="token punctuation">;</span> Max <span class="token operator">=</span> this<span class="token punctuation">.</span>Position <span class="token operator">+</span> playerSize<span class="token punctuation">}</span>

</code></pre>
<p>So now we can have abstraction like:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp"><span class="token keyword">let</span> <span class="token keyword">inline</span> getHitbox<span class="token operator">&lt;</span><span class="token string">'a when '</span>a<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">member</span> GetHitBox<span class="token punctuation">:</span> Hitbox<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> 'a<span class="token punctuation">)</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>GetHitBox
</code></pre>
<p>And of course, let’s add platforms to the state:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">type</span> GameState <span class="token operator">=</span> <span class="token punctuation">{</span>
  Player<span class="token punctuation">:</span> Player
  Platforms<span class="token punctuation">:</span> Platfotm list
<span class="token punctuation">}</span>

<span class="token keyword">let</span> platformWidth <span class="token operator">=</span> <span class="token number">30.0</span>
<span class="token keyword">let</span> mkPlatform pos length <span class="token operator">=</span> <span class="token punctuation">{</span>Hitbox <span class="token operator">=</span> <span class="token punctuation">{</span> Min <span class="token operator">=</span> pos<span class="token punctuation">;</span> Max <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>X <span class="token operator">+</span> length<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>Y <span class="token operator">+</span> platformWidth<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token function">initFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> GameState <span class="token operator">=</span> 
  <span class="token punctuation">{</span> Player <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    Platforms <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token function">mkPlatform</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">200</span>
                  <span class="token function">mkPlatform</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">150</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
                  
</code></pre>
<p>Before writing collision code, let’s firstly draw these platforms. Remember <code>playerToPoints</code> function? We can simply rewrite it to <code>hitboxToPoints</code>:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> <span class="token function">hitboxToPoints</span> <span class="token punctuation">(</span>resolution<span class="token punctuation">:</span> Vector<span class="token punctuation">)</span> <span class="token punctuation">(</span>h<span class="token punctuation">:</span> Hitbox<span class="token punctuation">)</span> <span class="token operator">=</span> 
  <span class="token keyword">let</span> hB <span class="token operator">=</span> <span class="token punctuation">{</span>
    Min <span class="token operator">=</span> resolution <span class="token operator">-</span> h<span class="token punctuation">.</span>Min
    Max <span class="token operator">=</span> resolution <span class="token operator">-</span> h<span class="token punctuation">.</span>Max
  <span class="token punctuation">}</span>
  <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>X<span class="token punctuation">,</span> hB<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>X<span class="token punctuation">,</span> hB<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>X<span class="token punctuation">,</span> hB<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>X<span class="token punctuation">,</span> hB<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
  
</code></pre>
<p>So, now we can see these platforms!<br>
<video width="320" height="240" controls loop>
<source	src="videos/showPlatforms.webm" type="video/webm">
</video>
</p>
<p>Ok, now let’s implement collision. Firstly, we need to make collision detection:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> <span class="token keyword">inline</span> collides h1 h2 <span class="token operator">=</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> getHitbox h1
    <span class="token keyword">let</span> b <span class="token operator">=</span> getHitbox h2
    a<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>X <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>X <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>X <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>X <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>Y <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>Y <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>Y <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>Y
    
</code></pre>
<p>Then, on every tick we will check every platform which collided with a player. If during collision player was falling on the platform from the top, it means player landed on it, so we’ll set players Y to platforms floor and Player.Grounded to true. Otherwise, we will push player out of the platform, to the side from which player appeared:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> checkCollision s <span class="token operator">=</span> 
        <span class="token keyword">let</span> collidedPlatforms <span class="token operator">=</span> s<span class="token punctuation">.</span>Platforms <span class="token operator">|</span><span class="token operator">&gt;</span> List<span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">(</span>collides s<span class="token punctuation">.</span>Player<span class="token punctuation">)</span>
        <span class="token keyword">let</span> foldFn player platform <span class="token operator">=</span> 
          <span class="token keyword">let</span> pPos<span class="token punctuation">,</span> pVel <span class="token operator">=</span> player<span class="token punctuation">.</span>Position<span class="token punctuation">,</span> player<span class="token punctuation">.</span>Velocity
          <span class="token keyword">let</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> playerMin<span class="token punctuation">;</span> Max <span class="token operator">=</span> playerMax<span class="token punctuation">}</span> <span class="token operator">=</span> player<span class="token punctuation">.</span>GetHitbox
          <span class="token keyword">let</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> platMin<span class="token punctuation">;</span> Max <span class="token operator">=</span> platMax<span class="token punctuation">}</span> <span class="token operator">=</span> platform<span class="token punctuation">.</span>Hitbox
          <span class="token keyword">let</span> isFalling <span class="token operator">=</span> pVel<span class="token punctuation">.</span>Y <span class="token operator">&lt;=</span> <span class="token number">0.0</span>
          <span class="token keyword">if</span>  isFalling <span class="token operator">&amp;&amp;</span> playerMin<span class="token punctuation">.</span>Y <span class="token operator">&gt;=</span> platMin<span class="token punctuation">.</span>Y <span class="token operator">&amp;&amp;</span> playerMax<span class="token punctuation">.</span>Y <span class="token operator">&gt;=</span> platMax<span class="token punctuation">.</span>Y <span class="token keyword">then</span> <span class="token comment">//when player is on topside</span>
              <span class="token keyword">let</span> newPos <span class="token operator">=</span> pPos <span class="token operator">|</span><span class="token operator">&gt;</span> _2v <span class="token punctuation">.</span><span class="token operator">-</span><span class="token operator">&gt;</span> platform<span class="token punctuation">.</span>Hitbox<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>Y
              <span class="token punctuation">{</span>player <span class="token keyword">with</span> Position <span class="token operator">=</span> newPos<span class="token punctuation">;</span> Grounded <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> playerMax<span class="token punctuation">.</span>Y <span class="token operator">&gt;=</span> platMin<span class="token punctuation">.</span>Y <span class="token operator">&amp;&amp;</span> playerMin<span class="token punctuation">.</span>Y <span class="token operator">&lt;</span> platMin<span class="token punctuation">.</span>Y <span class="token keyword">then</span> <span class="token comment">// from down</span>
              <span class="token punctuation">{</span> player <span class="token keyword">with</span> Position <span class="token operator">=</span> setl <span class="token function">_2v</span> <span class="token punctuation">(</span>platMin<span class="token punctuation">.</span>Y <span class="token operator">-</span> playerSize<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> pPos
                            Velocity <span class="token operator">=</span> setl <span class="token function">_2v</span> <span class="token punctuation">(</span><span class="token operator">-</span>g<span class="token punctuation">)</span> pVel <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> playerMin<span class="token punctuation">.</span>X <span class="token operator">&lt;=</span> platMin<span class="token punctuation">.</span>X <span class="token operator">&amp;&amp;</span> playerMax<span class="token punctuation">.</span>X <span class="token operator">&lt;=</span> platMax<span class="token punctuation">.</span>X <span class="token keyword">then</span> <span class="token comment">// from left</span>
              <span class="token punctuation">{</span> player <span class="token keyword">with</span> Position <span class="token operator">=</span> setl <span class="token function">_1v</span> <span class="token punctuation">(</span>platMin<span class="token punctuation">.</span>X <span class="token operator">-</span> playerSize<span class="token punctuation">.</span>X<span class="token punctuation">)</span> pPos <span class="token punctuation">}</span>
          <span class="token keyword">else</span> 
              <span class="token punctuation">{</span> player <span class="token keyword">with</span> Position <span class="token operator">=</span> setl _1v platMax<span class="token punctuation">.</span>X pPos <span class="token punctuation">}</span> <span class="token comment">// from right</span>
                
        <span class="token function">setl</span> <span class="token punctuation">(</span>_player <span class="token operator">&lt;</span><span class="token operator">&lt;</span> _grounded<span class="token punctuation">)</span> s<span class="token punctuation">.</span>Player<span class="token punctuation">.</span>Grounded s
          <span class="token operator">|</span><span class="token operator">&gt;</span> over <span class="token function">_player</span> <span class="token punctuation">(</span>collidedPlatforms <span class="token operator">|</span><span class="token operator">&gt;</span> <span class="token function">flip</span> <span class="token punctuation">(</span>List<span class="token punctuation">.</span>fold foldFn<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> updateFn <span class="token operator">=</span> <span class="token keyword">function</span> 
  <span class="token operator">|</span> Tick <span class="token operator">-</span><span class="token operator">&gt;</span> applyVel <span class="token operator">&gt;</span><span class="token operator">&gt;</span> applyDrag <span class="token operator">&gt;</span><span class="token operator">&gt;</span> applyG <span class="token operator">&gt;</span><span class="token operator">&gt;</span> floorCheck <span class="token operator">&gt;</span><span class="token operator">&gt;</span> checkCollision
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  
</code></pre>
<p>I was struggling a lot with writing this function, but hot reloading helped a lot with this debugging. (I wont show another demo tho, as it’d be too boring to look how I 10+minutes debug one single function)</p>
<p>Oh, and with this collision code, we can remove floorCheck from our pipeline - instead, we can represent floor as just another platform:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp"><span class="token keyword">let</span> floor <span class="token operator">=</span> <span class="token punctuation">{</span> Hitbox <span class="token operator">=</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> <span class="token function">Vector</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Max <span class="token operator">=</span> <span class="token function">Vector</span> <span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<h3 id="making-camera-move-alongside-player">Making camera move alongside player</h3>
<p>Ok but now we have one issue - if player moves further than screen size, we won’t se it. To counteract that, we’d modify hitboxToPoints function to also take into account players position:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> <span class="token function">hitboxToPoints</span> <span class="token punctuation">(</span>resolution<span class="token punctuation">:</span> Vector<span class="token punctuation">)</span> <span class="token function">offset</span> <span class="token punctuation">(</span>h<span class="token punctuation">:</span> Hitbox<span class="token punctuation">)</span> <span class="token operator">=</span> 
  <span class="token keyword">let</span> hB <span class="token operator">=</span> <span class="token punctuation">{</span>
    Min <span class="token operator">=</span> resolution <span class="token operator">-</span> h<span class="token punctuation">.</span>Min  <span class="token operator">+</span> offset
    Max <span class="token operator">=</span> resolution <span class="token operator">-</span> h<span class="token punctuation">.</span>Max <span class="token operator">+</span> offset
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> minX <span class="token operator">=</span> h<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>X <span class="token operator">-</span> offset<span class="token punctuation">.</span>X
  <span class="token keyword">let</span> maxX <span class="token operator">=</span> h<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>X <span class="token operator">-</span> offset<span class="token punctuation">.</span>X
  <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>minX<span class="token punctuation">,</span> hB<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>minX<span class="token punctuation">,</span> hB<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>maxX<span class="token punctuation">,</span> hB<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>maxX<span class="token punctuation">,</span> hB<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
  <span class="token punctuation">]</span>

<span class="token keyword">let</span> <span class="token function">getOffset</span> <span class="token punctuation">(</span>resolution<span class="token punctuation">:</span> Vector<span class="token punctuation">)</span> <span class="token punctuation">(</span>p<span class="token punctuation">:</span> Player<span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> halfRes <span class="token operator">=</span> resolution <span class="token operator">*</span> <span class="token number">0.5</span>
  <span class="token keyword">let</span> yRes <span class="token operator">=</span> resolution <span class="token operator">*</span> <span class="token number">0.2</span>
  <span class="token keyword">let</span> pPos <span class="token operator">=</span> p<span class="token punctuation">.</span>Position
  <span class="token keyword">let</span> xOffset <span class="token operator">=</span> <span class="token keyword">if</span> pPos<span class="token punctuation">.</span>X <span class="token operator">&gt;=</span> halfRes<span class="token punctuation">.</span>X <span class="token keyword">then</span> pPos<span class="token punctuation">.</span>X <span class="token operator">-</span> halfRes<span class="token punctuation">.</span>X <span class="token keyword">else</span> pPos<span class="token punctuation">.</span>X <span class="token operator">-</span> halfRes<span class="token punctuation">.</span>X
  <span class="token keyword">let</span> yOffset <span class="token operator">=</span> <span class="token keyword">if</span> pPos<span class="token punctuation">.</span>Y <span class="token operator">&gt;=</span> halfRes<span class="token punctuation">.</span>Y <span class="token keyword">then</span> pPos<span class="token punctuation">.</span>Y <span class="token operator">-</span> yRes<span class="token punctuation">.</span>Y <span class="token keyword">else</span> pPos<span class="token punctuation">.</span>Y <span class="token operator">-</span> yRes<span class="token punctuation">.</span>Y
  <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>xOffset<span class="token punctuation">,</span> yOffset<span class="token punctuation">)</span>
  
</code></pre>
<p>
<video width="320" height="240" controls loop>
<source	src="videos/addCamera.webm" type="video/webm">
</video>
</p>
<h2 id="adding-textures">Adding textures</h2>
<p>Let’s make our game pretty!</p>
<h3 id="player">Player</h3>
<p>We will start from the player. Our tilemap contains 4 player position, facing different directions. We will need to load bitmap, and then make image brush from it:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">  <span class="token keyword">let</span> playerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bitmap</span> <span class="token string">"Assets/player.png"</span>
  <span class="token keyword">let</span> playerDefault <span class="token operator">=</span> playerMap <span class="token operator">|</span><span class="token operator">&gt;</span> ImageBrush
  playerDefault<span class="token punctuation">.</span>SourceRect <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">RelativeRect</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> RelativeUnit<span class="token punctuation">.</span>Absolute<span class="token punctuation">)</span>
</code></pre>
<p>
<video width="320" height="240" controls loop>
<source	src="videos/addPlayerText.webm" type="video/webm">
</video>
</p>
<p>Right after adding our player you can see its very blurry, that’s because interpolation. We need to disable it:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">Control<span class="token punctuation">.</span>bitmapInterpolationMode BitmapInterpolationMode<span class="token punctuation">.</span>None
</code></pre>
<p>
<video width="320" height="240" controls loop>
<source	src="videos/removeInterpolation.webm" type="video/webm">
</video>
</p>
<p>In the same way, we will add brushes for all player directions:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
  <span class="token keyword">let</span> playerRight <span class="token operator">=</span> playerMap <span class="token operator">|</span><span class="token operator">&gt;</span> ImageBrush
  playerRight<span class="token punctuation">.</span>SourceRect <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">RelativeRect</span><span class="token punctuation">(</span><span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> RelativeUnit<span class="token punctuation">.</span>Absolute<span class="token punctuation">)</span>

  <span class="token keyword">let</span> playerLeft <span class="token operator">=</span> 
    <span class="token keyword">let</span> playerLeft <span class="token operator">=</span> playerMap <span class="token operator">|</span><span class="token operator">&gt;</span> ImageBrush
    playerLeft<span class="token punctuation">.</span>SourceRect <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">RelativeRect</span><span class="token punctuation">(</span><span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> RelativeUnit<span class="token punctuation">.</span>Absolute<span class="token punctuation">)</span>
    <span class="token keyword">let</span> mirrorMatrix <span class="token operator">=</span> 
      Matrix<span class="token punctuation">.</span><span class="token function">CreateScale</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">|</span><span class="token operator">&gt;</span> _<span class="token punctuation">.</span>Append
      <span class="token operator">&lt;</span><span class="token operator">|</span> Matrix<span class="token punctuation">.</span><span class="token function">CreateTranslation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>playerSize<span class="token punctuation">.</span>X<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    playerLeft<span class="token punctuation">.</span>Transform <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">MatrixTransform</span><span class="token punctuation">(</span>mirrorMatrix<span class="token punctuation">)</span>
    playerLeft

  <span class="token keyword">let</span> playerDown <span class="token operator">=</span> 
    <span class="token keyword">let</span> playerDown <span class="token operator">=</span> playerMap <span class="token operator">|</span><span class="token operator">&gt;</span> ImageBrush
    playerDown<span class="token punctuation">.</span>SourceRect <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">RelativeRect</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> RelativeUnit<span class="token punctuation">.</span>Absolute<span class="token punctuation">)</span>
    playerDown

  <span class="token keyword">let</span> playerJump <span class="token operator">=</span> 
    <span class="token keyword">let</span> playerJump <span class="token operator">=</span> playerMap <span class="token operator">|</span><span class="token operator">&gt;</span> ImageBrush
    playerJump<span class="token punctuation">.</span>SourceRect <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">RelativeRect</span><span class="token punctuation">(</span><span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> <span class="token number">16.0</span><span class="token punctuation">,</span> RelativeUnit<span class="token punctuation">.</span>Absolute<span class="token punctuation">)</span>
    playerJump

</code></pre>
<p>playerLeft is mirrored playerRight, so we had to apply transform matrix to it</p>
<p>And we’ll choose what tile to use by checking player’s velocity:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> drawPlayer res <span class="token function">offs</span> <span class="token punctuation">(</span>p<span class="token punctuation">:</span> Player<span class="token punctuation">)</span><span class="token punctuation">:</span> IView <span class="token operator">=</span> 
    <span class="token keyword">let</span> tile <span class="token operator">=</span>
      <span class="token keyword">match</span> p<span class="token punctuation">.</span>Velocity <span class="token keyword">with</span>
      <span class="token operator">|</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">when</span> y <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token operator">&gt;</span> playerJump
      <span class="token operator">|</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">when</span> y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">not</span> p<span class="token punctuation">.</span>Grounded <span class="token operator">-</span><span class="token operator">&gt;</span> playerDown
      <span class="token operator">|</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">when</span> x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token operator">&gt;</span> playerLeft
      <span class="token operator">|</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">when</span> x <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token operator">&gt;</span> playerRight
      <span class="token operator">|</span> _ <span class="token operator">-</span><span class="token operator">&gt;</span> playerDefault
    
    Polygon<span class="token punctuation">.</span>create <span class="token punctuation">[</span>
      <span class="token keyword">let</span> points <span class="token operator">=</span> hitboxToPoints res <span class="token function">offs</span> <span class="token punctuation">(</span>getHitbox p<span class="token punctuation">)</span>
      Control<span class="token punctuation">.</span>bitmapInterpolationMode BitmapInterpolationMode<span class="token punctuation">.</span>None
      Shapes<span class="token punctuation">.</span>Polygon<span class="token punctuation">.</span>points points
      Shapes<span class="token punctuation">.</span>Polygon<span class="token punctuation">.</span>fill tile
    <span class="token punctuation">]</span>

</code></pre>
<p>Where <code>Vec2</code> is neat active pattern:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token operator">|</span>Vec2<span class="token operator">|</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>v<span class="token punctuation">:</span> Vector<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>X<span class="token punctuation">,</span> v<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
</code></pre>
<p>Let’s make nice background too. We’ll add moon and clouds:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">let</span> drawMoon res <span class="token operator">=</span> 
    <span class="token keyword">let</span> moonSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> moonPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> hb <span class="token operator">=</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> moonPos<span class="token punctuation">;</span> Max <span class="token operator">=</span> moonPos <span class="token operator">+</span> moonSize<span class="token punctuation">}</span>
    <span class="token keyword">let</span> points <span class="token operator">=</span> hitboxToPoints <span class="token function">res</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> hb
    Polygon<span class="token punctuation">.</span>create <span class="token punctuation">[</span>
      Control<span class="token punctuation">.</span>bitmapInterpolationMode BitmapInterpolationMode<span class="token punctuation">.</span>None
      Shapes<span class="token punctuation">.</span>Polygon<span class="token punctuation">.</span>points points
      Shapes<span class="token punctuation">.</span>Polygon<span class="token punctuation">.</span>fill moonBrush
    <span class="token punctuation">]</span>

</code></pre>
<h3 id="world">World</h3>
<p>Clouds are a little bit trickier as we have only single 128x128 tile, and we need to spread them out. At first, let’s add few clouds manually:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">module</span> Clouds <span class="token operator">=</span> 
    <span class="token keyword">let</span> cloudsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bitmap</span> <span class="token string">"Assets/clouds.png"</span>
    <span class="token keyword">let</span> cloudScale <span class="token operator">=</span> <span class="token number">4.0</span>

    <span class="token keyword">let</span> mkBrush bitmap x y w h <span class="token operator">=</span> 
      <span class="token keyword">let</span> brush <span class="token operator">=</span> mkBrush bitmap x y w h
      brush<span class="token punctuation">.</span>Opacity <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token number">0.9</span>
      brush
    <span class="token keyword">let</span> cloud1 <span class="token operator">=</span> mkBrush cloudsMap <span class="token number">0</span> <span class="token number">0</span> <span class="token number">64</span> <span class="token number">32</span>
    <span class="token keyword">let</span> cloud2 <span class="token operator">=</span> mkBrush cloudsMap <span class="token number">64</span> <span class="token number">0</span> <span class="token number">64</span> <span class="token number">32</span>
    <span class="token keyword">let</span> bigCloud1 <span class="token operator">=</span> mkBrush cloudsMap <span class="token number">0</span> <span class="token number">32</span> <span class="token number">96</span> <span class="token number">32</span>
    <span class="token keyword">let</span> smolCloud <span class="token operator">=</span> mkBrush cloudsMap <span class="token number">96</span> <span class="token number">32</span> <span class="token number">32</span> <span class="token number">32</span>
    <span class="token keyword">let</span> bigCloud2 <span class="token operator">=</span> mkBrush cloudsMap <span class="token number">0</span> <span class="token number">64</span> <span class="token number">128</span> <span class="token number">64</span>

    <span class="token keyword">let</span> drawCloud res <span class="token function">offs</span> <span class="token punctuation">(</span>brush<span class="token punctuation">:</span> ImageBrush<span class="token punctuation">)</span> pos <span class="token operator">=</span> 
      <span class="token keyword">let</span> size <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>brush<span class="token punctuation">.</span>SourceRect<span class="token punctuation">.</span>Rect<span class="token punctuation">.</span>Width<span class="token punctuation">,</span> brush<span class="token punctuation">.</span>SourceRect<span class="token punctuation">.</span>Rect<span class="token punctuation">.</span>Height<span class="token punctuation">)</span> <span class="token operator">*</span> cloudScale
      <span class="token keyword">let</span> hb <span class="token operator">=</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> pos<span class="token punctuation">;</span> Max <span class="token operator">=</span> pos <span class="token operator">+</span> size<span class="token punctuation">}</span>
      mkPolygon res offs hb brush
    
    <span class="token keyword">let</span> drawClouds <span class="token function">res</span> <span class="token punctuation">(</span>offs<span class="token punctuation">:</span> Vector<span class="token punctuation">)</span> <span class="token operator">=</span> 
      <span class="token keyword">let</span> drawCloud brush x y <span class="token operator">=</span> drawCloud res Vector<span class="token punctuation">.</span>Zero <span class="token function">brush</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>float x<span class="token punctuation">,</span> float y<span class="token punctuation">)</span><span class="token punctuation">)</span>
      Panel<span class="token punctuation">.</span>create <span class="token punctuation">[</span>
        Panel<span class="token punctuation">.</span>children <span class="token punctuation">[</span>
          drawCloud smolCloud <span class="token number">500</span> <span class="token number">500</span>
          drawCloud bigCloud2 <span class="token number">300</span> <span class="token number">300</span>
        <span class="token punctuation">]</span> 
      <span class="token punctuation">]</span> <span class="token punctuation">:</span><span class="token operator">&gt;</span> IView

</code></pre>
<p>However, clouds right now look too flat. Let’s add parallax effect - all we need to do is provide offset multiplied by really small value:<br>
<video width="320" height="240" controls loop>
<source	src="videos/paralax.webm" type="video/webm">
</video>
</p>
<p>I also want clouds to drift and I realized I am too lazy to add all of them manually. So, they should be part of game state.</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">module</span> Clouds <span class="token operator">=</span> 
  <span class="token keyword">type</span> CloudType <span class="token operator">=</span> Cloud1 <span class="token operator">|</span> Cloud2 <span class="token operator">|</span> Long <span class="token operator">|</span> Smol <span class="token operator">|</span> Big
    <span class="token keyword">with</span> <span class="token keyword">static</span> <span class="token keyword">member</span> cases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">|</span>Cloud1<span class="token punctuation">;</span> Cloud2<span class="token punctuation">;</span> Long<span class="token punctuation">;</span> Smol<span class="token punctuation">;</span> Big <span class="token operator">|</span><span class="token punctuation">]</span>
  <span class="token keyword">type</span> Cloud <span class="token operator">=</span> <span class="token punctuation">{</span>
    Position<span class="token punctuation">:</span> Vector
    Type<span class="token punctuation">:</span> CloudType
    Velocity<span class="token punctuation">:</span> Vector
  <span class="token punctuation">}</span>
<span class="token keyword">type</span> GameState <span class="token operator">=</span> <span class="token punctuation">{</span>
  Player<span class="token punctuation">:</span> Player
  Platforms<span class="token punctuation">:</span> Platforms<span class="token punctuation">.</span>Platform list
  Clouds<span class="token punctuation">:</span> Clouds<span class="token punctuation">.</span>Cloud list
<span class="token punctuation">}</span>

</code></pre>
<p>We will generate platform like that:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
  <span class="token keyword">type</span> CloudVelocity <span class="token operator">=</span> Slow <span class="token operator">|</span> Fast <span class="token operator">|</span> VerySlow 
    <span class="token keyword">with</span> <span class="token keyword">static</span> <span class="token keyword">member</span> cases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">|</span>Slow<span class="token punctuation">;</span> Fast<span class="token punctuation">;</span> VerySlow<span class="token operator">|</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> generateRandomCloud pos <span class="token operator">=</span> 
    <span class="token keyword">let</span> cloudType <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">|</span><span class="token operator">&gt;</span> <span class="token keyword">fun</span> i <span class="token operator">-</span><span class="token operator">&gt;</span> CloudType<span class="token punctuation">.</span>cases<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">let</span> cloudVelocity <span class="token operator">=</span> 
      <span class="token keyword">match</span> random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">&gt;</span>  <span class="token keyword">fun</span> i <span class="token operator">-</span><span class="token operator">&gt;</span> CloudVelocity<span class="token punctuation">.</span>cases<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">with</span>
      <span class="token operator">|</span> Slow <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span>
      <span class="token operator">|</span> Fast <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span>
      <span class="token operator">|</span> VerySlow <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span>
    <span class="token keyword">let</span> velocityScale <span class="token operator">=</span> 
      <span class="token keyword">match</span> cloudType <span class="token keyword">with</span> 
      <span class="token operator">|</span> Big <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token number">0.3</span>
      <span class="token operator">|</span> _ <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token number">1.0</span>
    <span class="token punctuation">{</span>Position <span class="token operator">=</span> pos<span class="token punctuation">;</span> Type <span class="token operator">=</span> cloudType<span class="token punctuation">;</span> Velocity <span class="token operator">=</span> cloudVelocity <span class="token operator">*</span> velocityScale<span class="token punctuation">}</span>

</code></pre>
<p>And teleport back clouds which went too far out of game scene:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp"></code></pre>
<pre class=" language-fsharp"><code class="prism  language-fsharp">  <span class="token keyword">let</span> moveBackClouds <span class="token operator">=</span> over <span class="token function">_clouds</span> <span class="token punctuation">(</span>List<span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> c <span class="token operator">-</span><span class="token operator">&gt;</span> 
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Position<span class="token punctuation">.</span>X <span class="token operator">&gt;</span> cloudZone<span class="token punctuation">.</span>Max<span class="token punctuation">.</span>X <span class="token keyword">then</span> 
      <span class="token punctuation">{</span>c <span class="token keyword">with</span> Position <span class="token operator">=</span> setl _1v cloudZone<span class="token punctuation">.</span>Min<span class="token punctuation">.</span>X c<span class="token punctuation">.</span>Position<span class="token punctuation">}</span> 
    <span class="token keyword">else</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>So now it looks like this:<br>
<video width="320" height="240" controls loop>
<source	src="videos/movingClouds.webm" type="video/webm">
</video>
</p>
<p>We can also add glowing animation to the player and gradient for nicer sky:<br>
<video width="320" height="240" controls loop>
<source	src="videos/gradient.webm" type="video/webm">
</video>
</p>
<p>I’ve tried to add platforms in same way, by using built-in TileMode functionality. And this is when I realized I’ve should’ve use proper game framework and not an ui library:<br>
<video width="320" height="240" controls loop>
<source	src="videos/brokenText.webm" type="video/webm">
</video>
</p>
<p>No matter what I’ve tried, image kept moving alongside a camera. So, we’d need to use static images for each kind of platform. Let’s modify platform type to be like this:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp">
<span class="token keyword">type</span> PlatformType <span class="token operator">=</span> ShortPlatform <span class="token operator">|</span> LongPlatform <span class="token operator">|</span> SideWall <span class="token operator">|</span> Floor
<span class="token keyword">type</span> Platform <span class="token operator">=</span> <span class="token punctuation">{</span>
  Position<span class="token punctuation">:</span> Vector
  Type<span class="token punctuation">:</span> PlatformType
<span class="token punctuation">}</span> <span class="token keyword">with</span> 
  <span class="token keyword">member</span> this<span class="token punctuation">.</span>GetHitbox <span class="token operator">=</span>
    <span class="token keyword">match</span> this<span class="token punctuation">.</span>Type <span class="token keyword">with</span> 
    <span class="token operator">|</span> ShortPlatform <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> this<span class="token punctuation">.</span>Position<span class="token punctuation">;</span> Max <span class="token operator">=</span> this<span class="token punctuation">.</span>Position <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">|</span> LongPlatform <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> this<span class="token punctuation">.</span>Position<span class="token punctuation">;</span> Max <span class="token operator">=</span> this<span class="token punctuation">.</span>Position <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">|</span> Floor <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> this<span class="token punctuation">.</span>Position<span class="token punctuation">;</span> Max <span class="token operator">=</span> this<span class="token punctuation">.</span>Position <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    
    <span class="token operator">|</span> SideWall <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>Min <span class="token operator">=</span> this<span class="token punctuation">.</span>Position<span class="token punctuation">;</span> Max <span class="token operator">=</span> this<span class="token punctuation">.</span>Position <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">member</span> mk t x y <span class="token operator">=</span> <span class="token punctuation">{</span>Position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> Type <span class="token operator">=</span> t<span class="token punctuation">}</span>
  
</code></pre>
<p>And now it works:<br>
<img src="videos/textWork.png" alt=""></p>
<p>by providing state updater like:</p>
<pre class=" language-fsharp"><code class="prism  language-fsharp"><span class="token keyword">let</span> liveEditPlatforms s <span class="token operator">=</span> <span class="token punctuation">{</span>s <span class="token keyword">with</span> Platforms <span class="token operator">=</span> <span class="token function">getPlatforms</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre>
<p>we can in live edit create our level:<br>
<video width="320" height="240" controls loop>
<source	src="videos/end.webm" type="video/webm">
</video>
</p>
<p>That’s it!</p>
<h1 id="references">References</h1>
<p>I was heavily inspired by these articles:</p>
<ul>
<li><a href="https://clojure.org/guides/repl/introduction">https://clojure.org/guides/repl/introduction</a></li>
<li><a href="https://oli.me.uk/Blog+archive/2020/Conversational+software+development">https://oli.me.uk/Blog+archive/2020/Conversational+software+development</a></li>
</ul>
<p>Also, I really liked playing with <a href="https://shirakumo.github.io/trial/index.html">Trial Game Engine</a> and it encouraged me to showcase a game instead of something else. Check this game engine out! It is written in Lisp and also supports and encourages REPL driven development.</p>
<hr>
<p>I was writing this game as a demo for fsix, but I really enjoyed the process of making it. It gave me so many nostalgic feelings, when I was writing very simmilar simple games as highschooler. So maybe, in the future I’ll move this demo to <a href="https://www.raylib.com/">raylib-cs</a>, and implement some sort of ECS framework.</p>
<p>See you!</p>

    </div>
  </div>
</body>

</html>
